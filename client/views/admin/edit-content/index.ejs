<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Entry - Chilahati Archive</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin-add.css">
    <style>
        .delete-btn {
            background: #e74c3c;
            color: white;
            margin-top: 1rem;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>

    <%- include('../../partials/navbar') %>

        <div class="admin-container">
            <header class="admin-header">
                <h1><i class="fas fa-edit"></i> Edit Entry</h1>
                <p>Update existing archive page.</p>
            </header>

            <% if (locals.success_msg && success_msg.length > 0) { %>
                <div class="alert alert-success">
                    <%= success_msg %>
                </div>
            <% } %>
            <% if (locals.error_msg && error_msg.length > 0) { %>
                <div class="alert alert-danger">
                    <%= error_msg %>
                </div>
            <% } %>

            <form action="/admin/edit/<%= item._id %>" method="POST" id="mainForm">

                <!-- SECTION 1: CLASSIFICATION -->
                <div class="form-section">
                    <h3><i class="fas fa-sitemap"></i> Classification</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Main Category</label>
                            <select name="category" id="categorySelect" required>
                                <option value="">-- Select Main Category --</option>
                                <option value="history" <%=item.category==='history' ? 'selected' : '' %>>History</option>
                                <option value="culture" <%=item.category==='culture' ? 'selected' : '' %>>Culture</option>
                                <option value="institution" <%=item.category==='institution' ? 'selected' : '' %>>Institution</option>
                                <option value="notable people" <%=item.category==='notable people' ? 'selected' : '' %>>Notable People</option>
                                <option value="freedom fighters" <%=item.category==='freedom fighters' ? 'selected' : '' %>>Freedom Fighters</option>
                                <option value="meritorious student" <%=item.category==='meritorious student' ? 'selected' : '' %>>Meritorious Student</option>
                                <option value="hidden talent" <%=item.category==='hidden talent' ? 'selected' : '' %>>Hidden Talent</option>
                                <option value="occupation" <%=item.category==='occupation' ? 'selected' : '' %>>Occupation</option>
                                <option value="Heartbreaking stories" <%=item.category==='Heartbreaking stories' ? 'selected' : '' %>>Heartbreaking Stories</option>
                                <option value="tourist spots" <%=item.category==='tourist spots' ? 'selected' : '' %>>Tourist Spots</option>
                                <option value="transport" <%=item.category==='transport' ? 'selected' : '' %>>Transport</option>
                                <option value="Emergency services" <%=item.category==='Emergency services' ? 'selected' : '' %>>Emergency Services</option>
                                <option value="social works" <%=item.category==='social works' ? 'selected' : '' %>>Social Works</option>
                                <option value="interactive map" <%=item.category==='interactive map' ? 'selected' : '' %>>Interactive Map</option>
                            </select>
                        </div>

                        <div class="form-group hidden" id="subTypeContainer">
                            <label>Sub-Category (Important for Navigation)</label>
                            <select name="subType" id="subTypeSelect">
                                <!-- Dynamic Options Injected Here -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: BASIC INFO -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Basic Info</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" placeholder="Full name of person or place"
                            value="<%= item.title %>" required>
                    </div>
                    <div class="form-group">
                        <label>Slug (URL Link)</label>
                        <input type="text" name="slug" placeholder="e.g. chilahati-high-school" value="<%= item.slug %>"
                            required>
                    </div>
                    <div class="form-group">
                        <label>Thumbnail (Google Drive Image Link)</label>
                        <input type="text" name="thumbnail" placeholder="The cover image card link"
                            value="<%= item.thumbnail %>">
                    </div>
                </div>

                <!-- SECTION 3: DYNAMIC DETAILS (Changes based on selection) -->
                <div id="dynamicFields" class="form-section hidden">
                    <h3><i class="fas fa-list-ul"></i> Specific Details</h3>

                    <!-- A. LOCATION FIELDS -->
                    <div id="locationGroup" class="hidden">
                        <label>Google Maps Link</label>
                        <textarea name="locationLink" placeholder="Paste link from Google Maps (or just Place Name)" rows="2"><%= item.locationLink || '' %></textarea>
                        <label>Physical Address</label>
                        <input type="text" name="address" placeholder="Location description"
                            value="<%= item.address || '' %>">
                        <!-- Hidden Lat/Lng if we want to preserve them -->
                        <% if (item.coordinates) { %>
                            <input type="hidden" name="lat" value="<%= item.coordinates.lat %>">
                            <input type="hidden" name="lng" value="<%= item.coordinates.lng %>">
                            <% } %>
                    </div>

                    <!-- B. INSTITUTION SPECIFIC -->
                    <div id="InstitutionExtra" class="specific-group hidden">
                        <label>Head of Institution</label>
                        <input type="text" name="headOfInstitution" placeholder="e.g. Principal or Manager"
                            value="<%= item.headOfInstitution || '' %>">
                        <label>Established Date</label>
                        <% let estDate='' ; if(item.establishedDate) estDate=new
                            Date(item.establishedDate).toISOString().split('T')[0]; %>
                            <input type="date" name="establishedDate" value="<%= estDate %>">
                    </div>

                    <!-- C. PERSON SPECIFIC -->
                    <div id="PersonExtra" class="specific-group hidden">
                        <label>Education/Profession</label>
                        <input type="text" name="profession" placeholder="e.g. PhD, Artist, etc."
                            value="<%= item.profession || '' %>">
                        <label>Date of Birth</label>
                        <% let dob='' ; if(item.dateOfBirth) dob=new Date(item.dateOfBirth).toISOString().split('T')[0];
                            %>
                            <input type="date" name="dateOfBirth" value="<%= dob %>">
                            <label>Sector No (Only if Freedom Fighter)</label>
                            <input type="text" name="sectorNo" placeholder="Which sector did they fight in?"
                                value="<%= item.sectorNo || '' %>">
                    </div>

                    <!-- D. STORY/HERITAGE SPECIFIC -->
                    <div id="NarrativeExtra" class="specific-group hidden">
                        <label>Date of Event/Incident</label>
                        <% let evDate='' ; if(item.eventDate) evDate=new
                            Date(item.eventDate).toISOString().split('T')[0]; else if (item.dateOfIncident) evDate=new
                            Date(item.dateOfIncident).toISOString().split('T')[0]; %>
                            <input type="date" name="eventDate" value="<%= evDate %>">
                    </div>
                </div>

                <!-- SECTION 4: BLOCK EDITOR (Wikipedia Content) -->
                <div class="form-section">
                    <h3><i class="fas fa-edit"></i> Page Content (Wikipedia Blocks)</h3>
                    <div class="toolbar">
                        <button type="button" class="tool-btn" onclick="addBlock('heading')"><i
                                class="fas fa-heading"></i> Heading</button>
                        <button type="button" class="tool-btn" onclick="addBlock('paragraph')"><i
                                class="fas fa-paragraph"></i> Rich Text</button>
                        <button type="button" class="tool-btn" onclick="addBlock('image')"><i class="fas fa-image"></i>
                            Image</button>
                        <button type="button" class="tool-btn" onclick="addBlock('video')"><i class="fas fa-video"></i>
                            Video</button>
                        <button type="button" class="tool-btn" onclick="addBlock('link')"><i class="fas fa-link"></i>
                            Link</button>
                        <button type="button" class="tool-btn" onclick="addBlock('pdf')"><i class="fas fa-file-pdf"></i>
                            PDF</button>
                    </div>

                    <div id="editorContainer" class="block-editor">
                        <div id="emptyMessage" style="text-align:center; padding: 40px; color: #888; display: none;">
                            <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 10px;"></i>
                            <p>No content blocks yet. Click the buttons above to build the story.</p>
                        </div>
                    </div>

                    <!-- Hidden Input to store all content as JSON -->
                    <input type="hidden" name="bodyContentJSON" id="bodyContentJSON">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-block save-btn">Update Entry</button>
                    <button type="button" class="btn-block delete-btn" onclick="deleteItem()">Delete Entry</button>
                </div>
                <a href="/archive/<%= item.category %>" class="btn-block cancel-btn"
                    style="margin-top: 1rem; display:block; text-align:center;">Cancel</a>
            </form>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

        <script>
            // 0. Initial Data from Server
            const savedCategory = "<%= item.category %>";
            const savedSubType = "<%= item.subType %>";
            // prettier-ignore
            const savedBlocks = <%- JSON.stringify(item.bodyContent || []) %>;

            // 1. MAPPING CATEGORIES TO SUBTYPES
            const subTypeMap = {
                'institution': ['educational', 'governmental', 'Banks', 'Religious', 'other'],
                'transport': ['bus', 'train', 'auto stand', 'launch-ghat'],
                'Emergency services': ['hospitals', 'police', 'fire']
            };

            // 2. DYNAMIC DROPDOWN & FIELD LOGIC
            const categorySelect = document.getElementById('categorySelect');
            const subTypeContainer = document.getElementById('subTypeContainer');
            const subTypeSelect = document.getElementById('subTypeSelect');
            const dynamicFields = document.getElementById('dynamicFields');

            function updateUIForCategory(cat) {
                subTypeSelect.innerHTML = '';

                // Hide everything first
                subTypeContainer.classList.add('hidden');
                dynamicFields.classList.remove('hidden'); // Reveal dynamic section if a category is selected
                document.querySelectorAll('.specific-group, #locationGroup').forEach(el => el.classList.add('hidden'));

                if (!cat) {
                    dynamicFields.classList.add('hidden');
                    return;
                }

                if (subTypeMap[cat]) {
                    subTypeContainer.classList.remove('hidden');

                    // Fill Sub-Types
                    subTypeMap[cat].forEach(sub => {
                        let opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subTypeSelect.appendChild(opt);
                    });
                }

                // Conditional Detail Visibility
                if (['institution', 'tourist spots', 'transport', 'Emergency services', 'social works', 'interactive map'].includes(cat) || subTypeMap[cat]) {
                    document.getElementById('locationGroup').classList.remove('hidden');
                }
                if (cat === 'institution') document.getElementById('InstitutionExtra').classList.remove('hidden');
                if (['notable people', 'freedom fighters', 'meritorious student', 'hidden talent'].includes(cat)) {
                    document.getElementById('PersonExtra').classList.remove('hidden');
                }
                if (['history', 'culture', 'Heartbreaking stories'].includes(cat)) {
                    document.getElementById('NarrativeExtra').classList.remove('hidden');
                }
            }

            categorySelect.addEventListener('change', function () {
                updateUIForCategory(this.value);
            });

            // Initialize UI logic
            if (savedCategory) {
                updateUIForCategory(savedCategory);
                if (savedSubType) {
                    subTypeSelect.value = savedSubType;
                }
            }

            // 3. BLOCK EDITOR LOGIC
            const editorContainer = document.getElementById('editorContainer');
            const quillInstances = {};

            function addBlock(type, content = null) {
                document.getElementById('emptyMessage').style.display = 'none';
                const blockId = Date.now() + Math.floor(Math.random() * 1000); // Randomness for unique IDs
                const blockDiv = document.createElement('div');
                blockDiv.className = 'block-item';
                blockDiv.dataset.id = blockId;
                blockDiv.dataset.type = type;

                let inner = `<span class="block-label">${type.toUpperCase()}</span>`;

                if (type === 'heading') {
                    const val = content || '';
                    inner += `<input type="text" class="block-input" placeholder="Enter Sub-heading (e.g. Life History)" value="${val.replace(/"/g, '&quot;')}">`;
                } else if (type === 'image') {
                    // Handle both old object format and new string format
                    const url = (typeof content === 'string') ? content : (content ? content.url : '');
                    inner += `<input type="text" class="block-input" placeholder="Google Drive Image URL" value="${url}">`;
                } else if (type === 'video') {
                    const val = content || '';
                    inner += `<input type="text" class="block-input" placeholder="YouTube or Drive Link" value="${val}">`;
                } else if (type === 'pdf') {
                    const val = content || '';
                    inner += `<input type="text" class="block-input" placeholder="Google Drive PDF Link" value="${val}">
                              <small style="color: #4a90e2; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> Tip: Ensure sharing is set to "Anyone with the link"
                              </small>`;
                } else if (type === 'link') {
                    let title = '', url = '';
                    if (content) {
                        try {
                            const linkData = JSON.parse(content);
                            title = linkData.title || '';
                            url = linkData.url || '';
                        } catch (e) {
                            url = content; // Fallback if it's just a raw URL
                        }
                    }
                    inner += `<input type="text" class="block-input link-title" placeholder="Link Title (e.g. Download Form)" value="${title}">
                              <input type="text" class="block-input link-url" placeholder="Paste external URL here" value="${url}">`;
                } else if (type === 'paragraph') {
                    inner += `<div id="quill-${blockId}" class="quill-editor"></div>`;
                }

                blockDiv.innerHTML = inner + `<button type="button" class="remove-btn" onclick="this.parentElement.remove()">Ã—</button>`;
                editorContainer.appendChild(blockDiv);

                if (type === 'paragraph') {
                    quillInstances[blockId] = new Quill(`#quill-${blockId}`, { theme: 'snow' });
                    if (content) {
                        quillInstances[blockId].root.innerHTML = content;
                    }
                }
            }

            // Populate Blocks
            if (savedBlocks && savedBlocks.length > 0) {
                savedBlocks.sort((a, b) => a.order - b.order).forEach(block => {
                    addBlock(block.type, block.content);
                });
            } else {
                document.getElementById('emptyMessage').style.display = 'block';
            }

            // 4. PRE-SUBMIT: COLLECT EVERYTHING INTO JSON
            document.getElementById('mainForm').addEventListener('submit', function (e) {
                // 1. Process Thumbnail
                const thumbInput = document.querySelector('input[name="thumbnail"]');
                if (thumbInput && thumbInput.value) {
                    thumbInput.value = convertToDirectImageLink(thumbInput.value);
                }

                // 2. Process Blocks
                const blocks = document.querySelectorAll('.block-item');
                let contentArray = [];

                blocks.forEach((el, index) => {
                    const type = el.dataset.type;
                    const id = el.dataset.id;
                    let content = '';

                    if (type === 'paragraph') {
                        content = quillInstances[id].root.innerHTML;
                    } else if (type === 'heading') {
                        content = el.querySelector('.block-input').value;
                    } else if (type === 'image') {
                        content = convertToDirectImageLink(el.querySelector('.block-input').value);
                    } else if (type === 'video') {
                        content = convertToEmbedUrl(el.querySelector('.block-input').value);
                    } else if (type === 'pdf') {
                        content = convertToEmbedUrl(el.querySelector('.block-input').value);
                    } else if (type === 'link') {
                        const title = el.querySelector('.link-title').value;
                        const url = el.querySelector('.link-url').value;
                        content = JSON.stringify({ title, url });
                    }

                    contentArray.push({ type, content, order: index });
                });

                document.getElementById('bodyContentJSON').value = JSON.stringify(contentArray);
            });

            // Helper function
            window.convertToEmbedUrl = function (url) {
                if (!url) return '';
                const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^\&\n?#]+)/);
                if (ytMatch) return `https://www.youtube.com/embed/${ytMatch[1]}`;
                const gdMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/);
                if (gdMatch) return `https://drive.google.com/file/d/${gdMatch[1]}/preview`;
                if (url.includes('/embed/') || url.includes('/preview')) return url;
                return url;
            };

            window.convertToDirectImageLink = function (url) {
                if (!url) return '';
                // Check if it's already a direct Googleusercontent link or similar
                // But we still want to force lh3 if it's a drive link to ensure reliability
                if (url.includes('lh3.googleusercontent.com/d/')) return url;

                // Extract File ID
                const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/) || url.match(/id=([a-zA-Z0-9-_]+)/);
                if (idMatch) {
                    return `https://lh3.googleusercontent.com/d/${idMatch[1]}`;
                }
                return url;
            };

            function deleteItem() {
                if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                    fetch('/admin/delete/<%= item._id %>', { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                alert('Item deleted successfully.');
                                window.location.href = '/archive/<%= item.category %>';
                            } else {
                                alert('Error deleting: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(e => alert('Network error please try again'));
                }
            }
        </script>
</body>

</html>