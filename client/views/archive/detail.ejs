<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= item.title %> - Chilahati Archive
    </title>

    <!-- External Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/style.css"> <!-- Your main global CSS -->
    <link rel="stylesheet" href="/css/details.css"> <!-- The new Detail View CSS -->
</head>

<body>

    <%- include('../partials/navbar') %>

        <div class="main-content detail-page">
            <div class="detail-container">

                <!-- LEFT SIDE: Main Content -->
                <article class="content-area">
                    <header class="entry-header">
                        <nav class="breadcrumb" style="text-transform: capitalize;">
                            <a href="/archive/<%= item.category.replace(/\s+/g, '-') %>">
                                <%= item.category %>
                            </a>
                            <% if (item.subType) { %>
                                / <a href="/archive/<%= item.category.replace(/\s+/g, '-') %>/<%= item.subType %>">
                                    <%= item.subType %>
                                </a>
                                <% } %>
                        </nav>
                        <h1>
                            <%= item.title %>
                        </h1>
                        <hr>
                    </header>

                    <!-- Loop through bodyContent blocks -->
                    <div class="entry-body">
                        <% item.bodyContent.sort((a,b)=> a.order - b.order).forEach(block => { %>

                            <% if (block.type==='heading' ) { %>
                                <h2 class="block-heading">
                                    <%= block.content %>
                                </h2>

                                <% } else if (block.type==='paragraph' ) { %>
                                    <div class="block-paragraph"><%- block.content %></div>

                                    <% } else if (block.type==='image' ) { %>
                                        <figure class="block-image">
                                            <% let imgUrl='' ; let imgCaption='' ; if (typeof block.content==='string' )
                                                { imgUrl=block.content; } else if (block.content && block.content.url) {
                                                imgUrl=block.content.url; imgCaption=block.content.caption; } %>
                                                <img src="<%= imgUrl %>" alt="<%= imgCaption || item.title %>"
                                                    referrerpolicy="no-referrer" style="max-width:100%; height:auto;">
                                                <% if (imgCaption) { %>
                                                    <figcaption>
                                                        <%= imgCaption %>
                                                    </figcaption>
                                                    <% } %>
                                        </figure>

                                        <% } else if (block.type==='video' ) { %>
                                            <div class="block-video">
                                                <% let embedUrl=block.content; const
                                                    ytMatch=block.content.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^\&\n?#]+)/);
                                                    if (ytMatch) embedUrl=`https://www.youtube.com/embed/${ytMatch[1]}`;
                                                    const
                                                    gdMatch=block.content.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/);
                                                    if (gdMatch)
                                                    embedUrl=`https://drive.google.com/file/d/${gdMatch[1]}/preview`; %>
                                                    <iframe src="<%= embedUrl %>" frameborder="0"
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                        allowfullscreen></iframe>
                                            </div>

                                            <% } else if (block.type==='link' ) { let linkData={ title: 'Open Link' ,
                                                url: '#' }; try { linkData=JSON.parse(block.content); } catch(e) {
                                                linkData.url=block.content; } %>
                                                <div class="block-link">
                                                    <a href="<%= linkData.url %>" target="_blank" class="external-link">
                                                        <i class="fas fa-link"></i>
                                                        <%= linkData.title %>
                                                    </a>
                                                </div>

                                                <% } else if (block.type==='pdf' ) { %>
                                                    <div class="block-pdf">
                                                        <iframe src="<%= block.content %>" width="100%"
                                                            height="600px"></iframe>
                                                        <a href="<%= block.content %>" target="_blank"
                                                            class="download-link">
                                                            <i class="fas fa-external-link-alt"></i> Open Document in
                                                            New Tab
                                                        </a>
                                                    </div>
                                                    <% } %>
                                                        <% }) %>
                    </div>

                    <footer class="entry-footer">
                        <p>Contributed by: <strong>
                                <%= item.author ? item.author.username : 'Anonymous' %>
                            </strong></p>
                        <p>Last Updated: <%= new Date(item.updatedAt).toLocaleDateString() %>
                        </p>
                        <% if (user && (user.role==='admin' || user.role==='supervisor' )) { %>
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                <a href="/admin/edit/<%= item._id %>" class="btn-edit"
                                    style="padding: 0.6rem 1.2rem; background: #4a90e2; border-radius: 6px; text-decoration: none; color: white; font-weight: 600; display: inline-block;">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                            </div>
                            <% } %>
                    </footer>
                </article>

                <!-- RIGHT SIDE: Infobox (Quick Facts) -->
                <aside class="infobox">
                    <div class="infobox-title">
                        <%= item.title %>
                    </div>

                    <% if (item.thumbnail) { %>
                        <div class="infobox-image">
                            <img src="<%= item.thumbnail %>" alt="Thumbnail" referrerpolicy="no-referrer">
                        </div>
                        <% } %>

                            <table class="infobox-table">
                                <tr>
                                    <th>Category</th>
                                    <td style="text-transform: capitalize;">
                                        <%= item.category %>
                                    </td>
                                </tr>
                                <% let subTypeVal=item.subType || item.transportType || item.serviceType; if
                                    (subTypeVal) { %>
                                    <tr>
                                        <th>Sub-type</th>
                                        <td style="text-transform: capitalize;">
                                            <%= subTypeVal %>
                                        </td>
                                    </tr>
                                    <% } %>

                                        <!-- A. PERSONAL FIELDS -->
                                        <% if (item.dateOfBirth) { %>
                                            <tr>
                                                <th>Birth</th>
                                                <td>
                                                    <%= new Date(item.dateOfBirth).toLocaleDateString('en-GB', {
                                                        day: 'numeric' , month: 'short' , year: 'numeric' }) %>
                                                </td>
                                            </tr>
                                            <% } %>
                                                <% if (item.dateOfDeath) { %>
                                                    <tr>
                                                        <th>Death</th>
                                                        <td>
                                                            <%= new Date(item.dateOfDeath).toLocaleDateString('en-GB', {
                                                                day: 'numeric' , month: 'short' , year: 'numeric' }) %>
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                                        <% if (item.profession) { %>
                                                            <tr>
                                                                <th>Profession</th>
                                                                <td>
                                                                    <%= item.profession %>
                                                                </td>
                                                            </tr>
                                                            <% } %>
                                                                <% if (item.education) { %>
                                                                    <tr>
                                                                        <th>Education</th>
                                                                        <td>
                                                                            <%= item.education %>
                                                                        </td>
                                                                    </tr>
                                                                    <% } %>
                                                                        <% if (item.passingYear) { %>
                                                                            <tr>
                                                                                <th>Passing Year</th>
                                                                                <td>
                                                                                    <%= item.passingYear %>
                                                                                </td>
                                                                            </tr>
                                                                            <% } %>
                                                                                <% if (item.currentStatus) { %>
                                                                                    <tr>
                                                                                        <th>Status</th>
                                                                                        <td>
                                                                                            <%= item.currentStatus %>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <% } %>
                                                                                        <% if (item.achievements &&
                                                                                            item.achievements.length> 0)
                                                                                            { %>
                                                                                            <tr>
                                                                                                <th>Achievements</th>
                                                                                                <td>
                                                                                                    <ul
                                                                                                        style="margin:0; padding-left: 15px; font-size: 0.9em;">
                                                                                                        <%
                                                                                                            item.achievements.forEach(a=>
                                                                                                            { %>
                                                                                                            <li>
                                                                                                                <%= a %>
                                                                                                            </li>
                                                                                                            <% }) %>
                                                                                                    </ul>
                                                                                                </td>
                                                                                            </tr>
                                                                                            <% } %>
                                                                                                <% if (item.sectorNo) {
                                                                                                    %>
                                                                                                    <tr>
                                                                                                        <th>Sector No
                                                                                                        </th>
                                                                                                        <td>
                                                                                                            <%= item.sectorNo
                                                                                                                %>
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                    <% } %>

                                                                                                        <!-- B. HERITAGE / OCCUPATION / NARRATIVE -->
                                                                                                        <% if
                                                                                                            (item.period)
                                                                                                            { %>
                                                                                                            <tr>
                                                                                                                <th>Period
                                                                                                                </th>
                                                                                                                <td>
                                                                                                                    <%= item.period
                                                                                                                        %>
                                                                                                                </td>
                                                                                                            </tr>
                                                                                                            <% } %>
                                                                                                                <% if
                                                                                                                    (item.establishedDate)
                                                                                                                    { %>
                                                                                                                    <tr>
                                                                                                                        <th>Established
                                                                                                                        </th>
                                                                                                                        <td>
                                                                                                                            <%= new
                                                                                                                                Date(item.establishedDate).getFullYear()
                                                                                                                                %>
                                                                                                                        </td>
                                                                                                                    </tr>
                                                                                                                    <% }
                                                                                                                        %>
                                                                                                                        <% if
                                                                                                                            (item.significance)
                                                                                                                            {
                                                                                                                            %>
                                                                                                                            <tr>
                                                                                                                                <th>Significance
                                                                                                                                </th>
                                                                                                                                <td>
                                                                                                                                    <%= item.significance
                                                                                                                                        %>
                                                                                                                                </td>
                                                                                                                            </tr>
                                                                                                                            <% }
                                                                                                                                %>
                                                                                                                                <% if
                                                                                                                                    (item.traditionalName)
                                                                                                                                    {
                                                                                                                                    %>
                                                                                                                                    <tr>
                                                                                                                                        <th>Traditional
                                                                                                                                            Name
                                                                                                                                        </th>
                                                                                                                                        <td>
                                                                                                                                            <%= item.traditionalName
                                                                                                                                                %>
                                                                                                                                        </td>
                                                                                                                                    </tr>
                                                                                                                                    <% }
                                                                                                                                        %>
                                                                                                                                        <% let
                                                                                                                                            incidentDate=item.dateOfIncident;
                                                                                                                                            if
                                                                                                                                            (incidentDate)
                                                                                                                                            {
                                                                                                                                            %>
                                                                                                                                            <tr>
                                                                                                                                                <th>Date
                                                                                                                                                    of
                                                                                                                                                    Incident
                                                                                                                                                </th>
                                                                                                                                                <td>
                                                                                                                                                    <%= new
                                                                                                                                                        Date(incidentDate).toLocaleDateString('en-GB')
                                                                                                                                                        %>
                                                                                                                                                </td>
                                                                                                                                            </tr>
                                                                                                                                            <% }
                                                                                                                                                %>
                                                                                                                                                <% if
                                                                                                                                                    (item.toolsUsed
                                                                                                                                                    &&
                                                                                                                                                    item.toolsUsed.length>
                                                                                                                                                    0)
                                                                                                                                                    {
                                                                                                                                                    %>
                                                                                                                                                    <tr>
                                                                                                                                                        <th>Tools
                                                                                                                                                            Used
                                                                                                                                                        </th>
                                                                                                                                                        <td>
                                                                                                                                                            <%= item.toolsUsed.join(', ') %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.occupationStatus) { %>
                                <tr>
                                    <th>Current Status</th>
                                    <td>
                                        <span class="status-badge"><%= item.occupationStatus %></span>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.involvedParties && item.involvedParties.length > 0) { %>
                                <tr>
                                    <th>Involved Parties</th>
                                    <td>
                                        <%= item.involvedParties.join(' , ') %>
                                    </td>
                                </tr>
                                <% } %>

                                <!-- C. ORGANIZATIONAL -->
                                <% if (item.foundedBy) { %>
                                <tr>
                                    <th>Founded By</th>
                                    <td>
                                        <%= item.foundedBy %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.headOfInstitution) { %>
                                <tr>
                                    <th>Current Head</th>
                                    <td>
                                        <%= item.headOfInstitution %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.missionStatement) { %>
                                <tr>
                                    <th>Mission</th>
                                    <td>
                                        <div style="font-size: 0.85em; font-style: italic;">"<%= item.missionStatement %>"</div>
                                    </td>
                                </tr>
                                <% } %>

                                <!-- D. GEOGRAPHIC / SERVICE -->
                                <% if (item.address) { %>
                                <tr>
                                    <th>Address</th>
                                    <td>
                                        <%= item.address %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.contactPhone) { %>
                                <tr>
                                    <th>Contact</th>
                                    <td>
                                        <%= item.contactPhone %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.destinations && item.destinations.length > 0) { %>
                                <tr>
                                    <th>Destinations</th>
                                    <td>
                                        <%= item.destinations.join(' , ') %>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (item.category === ' Emergency services' && typeof item.is24Hours !=='undefined' ) { %>
                                                                                                                                                    <tr>
                                                                                                                                                        <th>24/7
                                                                                                                                                            Service
                                                                                                                                                        </th>
                                                                                                                                                        <td>
                                                                                                                                                            <%= item.is24Hours
                                                                                                                                                                ? 'Yes'
                                                                                                                                                                : 'No'
                                                                                                                                                                %>
                                                                                                                                                        </td>
                                                                                                                                                    </tr>
                                                                                                                                                    <% }
                                                                                                                                                        %>
                                                                                                                                                        <% if
                                                                                                                                                            (item.entryFee)
                                                                                                                                                            {
                                                                                                                                                            %>
                                                                                                                                                            <tr>
                                                                                                                                                                <th>Entry
                                                                                                                                                                    Fee
                                                                                                                                                                </th>
                                                                                                                                                                <td>
                                                                                                                                                                    <%= item.entryFee
                                                                                                                                                                        %>
                                                                                                                                                                </td>
                                                                                                                                                            </tr>
                                                                                                                                                            <% }
                                                                                                                                                                %>
                                                                                                                                                                <% if
                                                                                                                                                                    (item.bestTimeToVisit)
                                                                                                                                                                    {
                                                                                                                                                                    %>
                                                                                                                                                                    <tr>
                                                                                                                                                                        <th>Best
                                                                                                                                                                            Time
                                                                                                                                                                            to
                                                                                                                                                                            Visit
                                                                                                                                                                        </th>
                                                                                                                                                                        <td>
                                                                                                                                                                            <%= item.bestTimeToVisit
                                                                                                                                                                                %>
                                                                                                                                                                        </td>
                                                                                                                                                                    </tr>
                                                                                                                                                                    <% }
                                                                                                                                                                        %>
                            </table>

                            <% if (item.locationLink) { let mapUrl=item.locationLink.trim(); if
                                (!mapUrl.startsWith('http')) {
                                mapUrl=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.locationLink)}`;
                                } %>
                                <a href="<%= mapUrl %>" target="_blank" class="map-btn">
                                    <i class="fas fa-map-marker-alt"></i> View on Google Maps
                                </a>
                                <% } %>
                </aside>

            </div>
        </div>
        <%- include('../partials/footer') %>
</body>

</html>